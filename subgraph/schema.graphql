# Atlas Protocol Subgraph Schema
# This schema defines the entities that will be indexed by Goldsky/The Graph
# Focus: CVS (Collateral Value Score) calculation for IP-backed lending

# ========================================
# IP Asset & Usage Tracking
# ========================================

type IPAsset @entity {
  id: ID!
  ipId: Bytes!
  name: String!
  description: String!
  creator: Bytes!
  ipHash: String!
  timestamp: BigInt!
  blockNumber: BigInt!
  
  # Licensing & Commercial Use
  commercialUse: Boolean!
  derivatives: Boolean!
  royaltyPercent: BigInt!
  mintingFee: BigInt!
  
  # CVS Related Metrics
  totalUsageCount: BigInt!
  totalLicenseRevenue: BigInt!
  totalRemixes: BigInt!
  cvsScore: BigInt!
  
  # Relations
  usageEvents: [IPAssetUsage!]! @derivedFrom(field: "ipAsset")
  licenseSales: [DataLicenseSale!]! @derivedFrom(field: "ipAsset")
  vault: IDOVault @derivedFrom(field: "ipAsset")
}

# Core Entity: Track every usage, license, or remix event of an IP
type IPAssetUsage @entity {
  id: ID!
  ipAsset: IPAsset!
  user: Bytes!
  usageType: String! # "license", "remix", "commercial", "derivative"
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
  
  # Revenue & Value Tracking
  revenueGenerated: BigInt!
  
  # CVS Impact
  cvsImpact: BigInt! # How much this usage contributed to CVS
}

# ========================================
# ADLV (Liquidity Vault) Entities - CVS Focus
# ========================================

# Core Entity: Track ADLV vault states with CVS
type IDOVault @entity {
  id: ID!
  vaultAddress: Bytes!
  creator: Bytes!
  ipAsset: IPAsset!
  
  # CVS (Collateral Value Score) Metrics
  currentCVS: BigInt!
  initialCVS: BigInt!
  lastCVSUpdate: BigInt!
  
  # Vault Status
  totalLiquidity: BigInt!
  availableLiquidity: BigInt!
  totalLoansIssued: BigInt!
  activeLoansCount: BigInt!
  
  # Loan Terms based on CVS
  maxLoanAmount: BigInt! # Based on CVS
  interestRate: BigInt! # Dynamic based on CVS
  collateralRatio: BigInt! # Required collateral %
  
  # Financial Metrics
  totalLicenseRevenue: BigInt!
  totalLoanRepayments: BigInt!
  utilizationRate: BigDecimal!
  
  # Timestamps
  createdAt: BigInt!
  updatedAt: BigInt!
  
  # Relations
  loans: [Loan!]! @derivedFrom(field: "vault")
  licenseSales: [DataLicenseSale!]! @derivedFrom(field: "vault")
  deposits: [Deposit!]! @derivedFrom(field: "vault")
}

# Core Entity: Track every data license sale through ADLV
type DataLicenseSale @entity {
  id: ID!
  vault: IDOVault!
  ipAsset: IPAsset!
  licensee: Bytes!
  
  # Sale Details
  salePrice: BigInt!
  licenseType: String! # "commercial", "derivative", "exclusive"
  duration: BigInt! # License duration in seconds
  
  # Revenue Distribution
  creatorShare: BigInt!
  vaultShare: BigInt!
  protocolFee: BigInt!
  
  # CVS Impact
  cvsIncrement: BigInt! # How much this sale increased CVS
  
  # Status
  isActive: Boolean!
  expiresAt: BigInt!
  
  # Timestamps
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

type Loan @entity {
  id: ID!
  loanId: BigInt!
  vault: IDOVault!
  borrower: Bytes!
  
  # Loan Terms
  loanAmount: BigInt!
  collateralAmount: BigInt!
  interestRate: BigInt!
  duration: BigInt!
  
  # CVS at Loan Issuance
  cvsAtIssuance: BigInt!
  requiredCVS: BigInt!
  
  # Loan Status
  status: LoanStatus!
  repaidAmount: BigInt!
  outstandingAmount: BigInt!
  
  # Timestamps
  startTime: BigInt!
  endTime: BigInt!
  issuedAt: BigInt!
  lastPaymentAt: BigInt
  
  # Relations
  payments: [LoanPayment!]! @derivedFrom(field: "loan")
}

enum LoanStatus {
  Pending
  Active
  Repaid
  Defaulted
  Liquidated
}

type LoanPayment @entity {
  id: ID!
  loan: Loan!
  payer: Bytes!
  amount: BigInt!
  isPrincipal: Boolean!
  timestamp: BigInt!
  blockNumber: BigInt!
}

type Deposit @entity {
  id: ID!
  vault: IDOVault!
  depositor: Bytes!
  amount: BigInt!
  shares: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
}

# ========================================
# IDO Entities
# ========================================

type IDOPool @entity {
  id: ID!
  tokenAddress: Bytes!
  tokenSymbol: String!
  totalSupply: BigInt!
  price: BigInt!
  startTime: BigInt!
  endTime: BigInt!
  minContribution: BigInt!
  maxContribution: BigInt!
  raised: BigInt!
  participantCount: BigInt!
  isActive: Boolean!
  
  # Relations
  participations: [IDOParticipation!]! @derivedFrom(field: "pool")
}

type IDOParticipation @entity {
  id: ID!
  pool: IDOPool!
  participant: Bytes!
  amount: BigInt!
  timestamp: BigInt!
  claimed: Boolean!
}

# ========================================
# Cross-Chain Bridge Entities
# ========================================

type BridgeTransaction @entity {
  id: ID!
  fromChainId: BigInt!
  toChainId: BigInt!
  sender: Bytes!
  recipient: Bytes!
  tokenAddress: Bytes!
  amount: BigInt!
  status: BridgeStatus!
  timestamp: BigInt!
  completedAt: BigInt
}

enum BridgeStatus {
  Initiated
  Pending
  Completed
  Failed
}

# ========================================
# World ID Verification Entities
# ========================================

type WorldIDVerification @entity {
  id: ID!
  user: Bytes!
  nullifierHash: String!
  verified: Boolean!
  verificationLevel: String!
  timestamp: BigInt!
}

# ========================================
# CVS Oracle Tracking
# ========================================

type CVSUpdate @entity {
  id: ID!
  ipId: Bytes!
  oldValue: BigInt!
  newValue: BigInt!
  confidence: BigInt!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
  source: String! # "oracle", "spg-sync", "manual"
}

# ========================================
# Multi-Asset Vault Entities
# ========================================

type MultiAssetVault @entity {
  id: ID!
  vaultAddress: Bytes!
  creator: Bytes!
  vaultType: VaultType!
  
  # Multi-Asset Metrics
  totalCVS: BigInt!
  ipAssetCount: BigInt!
  
  # Vault Status
  totalLiquidity: BigInt!
  availableLiquidity: BigInt!
  totalLoansIssued: BigInt!
  activeLoansCount: BigInt!
  totalLicenseRevenue: BigInt!
  
  # Timestamps
  createdAt: BigInt!
  updatedAt: BigInt!
  
  # Relations
  ipAssets: [VaultIPAsset!]! @derivedFrom(field: "vault")
  licenseSales: [MultiAssetLicenseSale!]! @derivedFrom(field: "vault")
}

enum VaultType {
  Single
  Multi
  Basket
}

type VaultIPAsset @entity {
  id: ID!
  vault: MultiAssetVault!
  ipId: Bytes!
  storyIPId: String!
  weight: BigInt!
  cvsValue: BigInt!
  licenseRevenue: BigInt!
  isActive: Boolean!
  addedAt: BigInt!
}

type MultiAssetLicenseSale @entity {
  id: ID!
  vault: MultiAssetVault!
  licensee: Bytes!
  ipIds: [Bytes!]!
  salePrice: BigInt!
  licenseType: String!
  timestamp: BigInt!
  blockNumber: BigInt!
  transactionHash: Bytes!
}

# ========================================
# Global Statistics
# ========================================

type GlobalStats @entity {
  id: ID!
  totalIPAssets: BigInt!
  totalLicenses: BigInt!
  totalLoans: BigInt!
  totalIDOPools: BigInt!
  totalBridgeTransactions: BigInt!
  totalVerifiedUsers: BigInt!
  totalMultiAssetVaults: BigInt!
  lastUpdated: BigInt!
}

